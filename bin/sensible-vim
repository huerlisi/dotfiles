#!/bin/sh

if [ -n "$CMD" ]; then
  vim="$CMD"
elif [ -n "$DISPLAY" -a -z "$SSH_CONNECTION" ] && which gvim &>/dev/null; then
  vim="gvim"
elif [ "`uname -s`" = "Darwin" ] && which mvim &>/dev/null; then
  vim="mvim"
else
  vim="vim"
fi

# Strip line numbers from filenames
args=( "$@" )
for (( i = 0; i < ${#args[@]}; i++ )); do
  if [ "${i:0:1}" != "-" ] && [[ "${args[i]}" =~ :[0-9]+$ ]]; then
    line="+${args[i]##*:}"
    args[i]="${args[i]%:*}"
  fi
done

# Detect binary filetypes
if [ ${#args[@]} -gt 0 ]; then
  mimetypes=$(
    file -L --brief --mime-type "${args[@]}" \
      | fgrep -vx 'image/svg+xml' \
      | fgrep -vx 'inode/directory' \
      | grep -P '^((?!text/).+|text/rtf)$'
  )

  if [ -n "$mimetypes" ]; then
    echo -ne "Open binary \e[1;37m$mimetypes\e[0m with \e[1;37mxdg-open\e[0m? [Y/n] "
    read
    if [ "$REPLY" != "n" ]; then
      for (( i = 0; i < ${#args[@]}; i++ )); do
        exec xdg-open "${args[i]}"
      done

      exit
    fi
  fi
fi

exec $vim "${args[@]}" $line
