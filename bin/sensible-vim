#!/bin/sh

unset options

if [ -n "$CMD" ]; then
  command="$CMD"
elif [ -n "$DISPLAY" -a -z "$SSH_CONNECTION" ] && which gvim &>/dev/null; then
  [ -t 0 ] || options="-f"
  command="gvim"
else
  command="vim"
fi

# Strip line numbers from filenames
args=( "$@" )
for (( i = 0; i < ${#args[@]}; i++ )); do
  if [ "${i:0:1}" != "-" ] && [[ "${args[i]}" =~ :[0-9]+$ ]]; then
    line="+${args[i]##*:}"
    args[i]="${args[i]%:*}"
  fi
done

# Detect binary filetypes
# if [ ${#args[@]} -gt 0 ]; then
#   mimetypes=`file -L --brief --mime-type "${args[@]}" | grep -vx 'inode/directory' | grep -P '^((?!text/).+|text/rtf)$'`
#   if [ -n "$mimetypes" ]; then
#     echo -e "Using \e[1;37mxdg-open\e[0m for \e[1;33m$mimetypes\e[0m"
#     for (( i = 0; i < ${#args[@]}; i++ )); do
#       exec xdg-open "${args[i]}"
#     done
#     exit
#   fi
# fi

exec $command $options "${args[@]}" $line
