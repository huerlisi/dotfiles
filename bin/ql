#!/bin/bash

PIPE=~/.quodlibet/control

CURRENT=~/.quodlibet/current

function _ql {
  echo "$1" > $PIPE
}

function is_running {
  [ -p $PIPE ] && pgrep -x quodlibet &>/dev/null
}

function _song {
  awk -F= "/^$1=(.*)/ { print \$2 }" $CURRENT
}

command="$1"
argument="$2"

case "$command" in
  play-file) command="add-file";;
  queue) command="enqueue";;
  rate) command="set-rating";;
  playlist) command="dump-playlist";;
  shuffle) command="order";;
  fastforward)
    command="seek"
    argument="+0:5"
    ;;
  rewind)
    command="seek"
    argument="-0:5"
    ;;
  start)
    if is_running; then
      echo "Quod Libet is already running."
      exit 1
    else
      shift
      quodlibet "$@" &>/dev/null &

      for i in `seq 1 300`; do
        if is_running; then
          query=`head -1 ~/.quodlibet/lists/queries.saved 2>/dev/null`
          if [ -n "$query" ]; then
            _ql "query $query"
          fi

          exit 0
        fi

        sleep 0.2
      done

      echo "E: Couldn't start Quod Libet, giving up."
      exit 1
    fi
    ;;
  start-hidden)
    shift

    if $0 start "$@"; then
      command="hide-window"
    else
      exit 1
    fi
    ;;
esac

if ! is_running; then
  echo "E: Quod Libet is not running."
  exit 1
fi

case "$command" in
  current)
    cat $CURRENT
    ;;
  query|search)
    if [ -n "$argument" ]; then
      _ql "set-browser SearchBar"
      _ql "query $argument"
      _ql "set-browser PanedBrowser"
      exit
    else
      echo "E: '$command' needs an argument."
      exit 1
    fi
    ;;
  status|dump-playlist|dump-queue)
    tmp=`mktemp`
    _ql "$command $tmp"
    sleep 0.05
    cat $tmp
    rm -f $tmp
    ;;
  next|previous|play|pause|play-pause|hide-window|show-window|toggle-window|focus)
    _ql "$command"
    ;;
  seek|order|repeat|volume|query|add-file|set-rating|set-browser|open-browser|song-list|random|filter|enqueue|unqueue)
    case "$command" in
      shuffle|order|repeat) argument=${argument:-toggle};;
    esac

    if [ -n "$argument" ]; then
      _ql "$command $argument"
    else
      echo "E: '$command' needs an argument."
      exit 1
    fi
    ;;
  volume-up)
    _ql "volume +"
    ;;
  volume-down)
    _ql "volume -"
    ;;
  quit)
    timeout 10 quodlibet --quit
    killall quodlibet &>/dev/null
    killall -9 quodlibet &>/dev/null
    ;;
  *)
    echo "E: unknown command '$command'."
    exit 1
    ;;
esac
